<!-- src/app/admin/company-list/company-list.component.html -->
<div class="admin-page-container">
  <mat-toolbar color="primary" class="admin-toolbar">
    <button mat-icon-button (click)="drawer.toggle()" aria-label="Toggle Sidenav">
      <mat-icon>menu</mat-icon>
    </button>
    <span>Panel de Administración - Empresas</span>
    <span class="toolbar-spacer"></span>
    <button mat-flat-button color="accent" (click)="openCreateCompanyDialog()" *ngIf="currentUser?.role === Role.Administrador">
        <mat-icon>add_business</mat-icon> Nueva Empresa
    </button>
  </mat-toolbar>

  <mat-sidenav-container class="admin-sidenav-container">
    <mat-sidenav #drawer mode="side" [opened]="true" class="admin-sidenav">
      <mat-nav-list>
        <h3 matSubheader>Gestión</h3>
        <a mat-list-item (click)="navigateToCompanies()" *ngIf="currentUser?.role === Role.Administrador">
          <mat-icon matListItemIcon>business</mat-icon>
          <span matListItemTitle>Empresas</span>
        </a>
        <a mat-list-item (click)="navigateToOperations()" *ngIf="currentUser?.role !== Role.Administrador">
          <mat-icon matListItemIcon>assignment</mat-icon>
          <span matListItemTitle>Operaciones</span>
        </a>
        <a mat-list-item (click)="navigateToUsers()">
          <mat-icon matListItemIcon>people</mat-icon>
          <span matListItemTitle>Usuarios</span>
        </a>
        <mat-divider></mat-divider>
        <a mat-list-item (click)="logout()">
          <mat-icon matListItemIcon>exit_to_app</mat-icon>
          <span matListItemTitle>Cerrar Sesión</span>
        </a>
      </mat-nav-list>
    </mat-sidenav>

    <mat-sidenav-content class="admin-sidenav-content">
      <div class="content-wrapper">
        <div class="welcome-message" *ngIf="currentUser">
          <p>Gestionando empresas como <strong>{{ currentUser.username }}</strong> (Rol: {{ currentUser.role }})</p>
        </div>

        <mat-card class="data-card">
          <mat-card-header>
            <mat-card-title>Lista de Empresas</mat-card-title>
            <button mat-icon-button (click)="loadCompanies()" matTooltip="Recargar lista">
              <mat-icon>refresh</mat-icon>
            </button>
          </mat-card-header>
          <mat-card-content>
            <!-- ... (contenedores para isLoading, error, empty state) ... -->

            <div class="table-container" *ngIf="!isLoadingCompanies && !companiesError && companies.length > 0">
              <table mat-table [dataSource]="companies" class="mat-elevation-z4 data-table">

                <!-- ID Column -->
                <ng-container matColumnDef="id">
                  <th mat-header-cell *matHeaderCellDef> ID </th>
                  <td mat-cell *matCellDef="let company"> {{company.id}} </td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef> Nombre Empresa </th>
                  <td mat-cell *matCellDef="let company"> {{company.name}} </td>
                </ng-container>

                <!-- NumberOfAgents Column -->
                <ng-container matColumnDef="numberOfAgents">
                  <th mat-header-cell *matHeaderCellDef class="number-column"> Agentes </th>
                  <td mat-cell *matCellDef="let company" class="number-column"> {{company.numberOfAgents}} </td>
                </ng-container>

                <!-- OperationsUsage Column -->
                <ng-container matColumnDef="operationsUsage">
                  <th mat-header-cell *matHeaderCellDef class="operations-usage-column"> Operaciones (Mes Actual) </th>
                  <td mat-cell *matCellDef="let company" class="operations-usage-cell">
                    <div class="usage-info">
                      <span class="usage-fraction">{{ company.currentMonthOperationsCount || 0 }} / {{ company.hasUnlimitedOperations ? '∞' : company.maxMonthlyOperations }}</span>
                      <mat-icon 
                        *ngIf="!company.hasUnlimitedOperations && company.hasReachedMonthlyLimit" 
                        color="warn" 
                        matTooltip="Límite alcanzado"
                        class="warning-icon">
                        warning
                      </mat-icon>
                    </div>
                  </td>
                </ng-container>

                <!-- CreatedAt Column -->
                <ng-container matColumnDef="createdAt">
                  <th mat-header-cell *matHeaderCellDef> Fecha Creación </th>
                  <td mat-cell *matCellDef="let company"> {{company.createdAt | date:'dd/MM/yyyy'}} </td>
                </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef class="actions-header"> Acciones </th>
                  <td mat-cell *matCellDef="let company" class="actions-cell">
                    <button mat-icon-button color="primary" (click)="openEditCompanyDialog(company)" matTooltip="Editar Empresa">
                      <mat-icon>edit</mat-icon>
                    </button>
                    <!-- BOTÓN DE ELIMINAR CON IMAGEN DE PAPELERA ROJA -->
            <button mat-icon-button color="warn" (click)="deleteCompany(company)" matTooltip="Eliminar Empresa">
              <mat-icon>delete</mat-icon>
            </button>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>
            </div>

          </mat-card-content>
        </mat-card>
      </div>
    </mat-sidenav-content>
  </mat-sidenav-container>
</div>