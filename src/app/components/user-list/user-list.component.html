<!-- src/app/admin/user-list/user-list.component.html -->

<div class="admin-page-container">
  <!-- Contenido principal sin sidenav -->
  <div class="admin-content">
    <div class="content-wrapper">
        <!-- Pestañas para superusuario y administrador -->
        <mat-tab-group class="main-tabs" 
                       [(selectedIndex)]="activeTabIndex" 
                       (selectedIndexChange)="onTabChange($event)"
                       animationDuration="0ms">
          <!-- Pestaña de Usuarios -->
          <mat-tab label="Usuarios" *ngIf="currentUser?.role === Role.Administrador || currentUser?.role === Role.Superusuario">
            <mat-card class="users-card">
              <mat-card-header>
                <button mat-flat-button color="accent" class="create-user-button"
                      routerLink="/register"
                      [queryParams]="{
                        adminAction: 'true'
                      }">
                <mat-icon>person_add</mat-icon> Crear Usuario
              </button>
                <button mat-icon-button (click)="loadUsers()" matTooltip="Recargar lista">
                  <mat-icon>refresh</mat-icon>
                </button>
              </mat-card-header>
              <mat-card-content>
                  <!-- ... (Spinner, Mensaje de Error, Mensaje de Vacío) ... -->
                  <div *ngIf="isLoadingUsers" class="spinner-container">
                    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
                    <p>Cargando usuarios...</p>
                  </div>

                  <div *ngIf="!isLoadingUsers && usersError" class="error-message-users">
                    <mat-icon color="warn">error_outline</mat-icon>
                    <p>{{ usersError }}</p>
                    <button mat-stroked-button color="primary" (click)="loadUsers()">Reintentar</button>
                  </div>

                  <div *ngIf="!isLoadingUsers && !usersError && displayedUsers.length === 0" class="empty-state-users">
                    <mat-icon class="empty-icon">no_accounts</mat-icon>
                    <p>No hay usuarios para mostrar.</p>
                  </div>

                  <!-- Tabla de Usuarios -->
                  <div class="table-container" *ngIf="!isLoadingUsers && !usersError && displayedUsers.length > 0">
                    <table mat-table [dataSource]="displayedUsers" class="mat-elevation-z4 users-table">

                      <!-- Username Column -->
                      <ng-container matColumnDef="username">
                        <th mat-header-cell *matHeaderCellDef> Usuario </th>
                        <td mat-cell *matCellDef="let user"> {{user.username}} </td>
                      </ng-container>
                      <!-- Email Column -->
                      <ng-container matColumnDef="email">
                        <th mat-header-cell *matHeaderCellDef> Email </th>
                        <td mat-cell *matCellDef="let user"> {{user.email}} </td>
                      </ng-container>
                      <!-- Role Column -->
                      <ng-container matColumnDef="role">
                        <th mat-header-cell *matHeaderCellDef> Rol </th>
                        <td mat-cell *matCellDef="let user"> {{user.role}} </td>
                      </ng-container>
                      <!-- CompanyName Column -->
                      <ng-container matColumnDef="companyName">
                        <th mat-header-cell *matHeaderCellDef> Empresa </th>
                        <td mat-cell *matCellDef="let user"> {{user.companyName || 'N/A'}} </td>
                      </ng-container>
                      <!-- CreatedAt Column -->
                      <ng-container matColumnDef="createdAt">
                        <th mat-header-cell *matHeaderCellDef> Registrado </th>
                        <td mat-cell *matCellDef="let user"> {{user.createdAt | date:'dd/MM/yyyy HH:mm'}} </td>
                      </ng-container>
                      <!-- Actions Column -->
                      <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef> Acciones </th>
                        <td mat-cell *matCellDef="let user">
                          <button mat-icon-button color="primary" (click)="editUser(user)" matTooltip="Editar Usuario"
                                  *ngIf="currentUser && currentUser.role === Role.Administrador">
                            <mat-icon>edit</mat-icon>
                          </button>
            <button mat-icon-button color="warn" (click)="deleteUser(user)" matTooltip="Eliminar Usuario"
                    *ngIf="currentUser && currentUser.id !== user.id && currentUser.role === Role.Administrador">
              <mat-icon>delete</mat-icon>
            </button>
                        </td>
                      </ng-container>

                      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                    </table>
                    <mat-paginator [length]="totalUsers"
                                   [pageSize]="usersPageSize"
                                   [pageSizeOptions]="[10, 25, 50, 100]"
                                   (page)="onUsersPageChange($event)"
                                   showFirstLastButtons>
                    </mat-paginator>
                  </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <!-- Pestaña de Operaciones -->
          <mat-tab label="Operaciones de la Empresa" *ngIf="currentUser?.role === Role.Superusuario || currentUser?.role === Role.Usuario">
            <app-operation-search 
              (searchChanged)="onSearchChanged($event)"
              *ngIf="currentUser">
            </app-operation-search>
            
            <mat-card class="operations-card">
              <mat-card-header>
                <mat-card-title>
                  {{ isSearching ? 'Resultados de Búsqueda' : 'Operaciones de ' + currentUser?.companyName }}
                  <span *ngIf="isSearching">({{ companyOperations.length }})</span>
                </mat-card-title>
                <button mat-flat-button color="accent" class="create-operation-button"
                        (click)="openCreateOperationDialog()"
                        style="margin-right: 8px;">
                  <mat-icon>add_task</mat-icon> Nueva Operación
                </button>
                <button mat-icon-button (click)="loadCompanyOperations()" matTooltip="Recargar operaciones">
                  <mat-icon>refresh</mat-icon>
                </button>
              </mat-card-header>
              <mat-card-content>
                <!-- Spinner de carga -->
                <div *ngIf="isLoadingOperations" class="spinner-container">
                  <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
                  <p>Cargando operaciones...</p>
                </div>

                <!-- Mensaje de error -->
                <div *ngIf="!isLoadingOperations && operationsError" class="error-message-operations">
                  <mat-icon color="warn">error_outline</mat-icon>
                  <p>{{ operationsError }}</p>
                  <button mat-stroked-button color="primary" (click)="loadCompanyOperations()">Reintentar</button>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!isLoadingOperations && !operationsError && getDisplayOperations().length === 0 && getDisplayPendingOperations().length === 0" class="empty-state-operations">
                  <mat-icon class="empty-icon">assignment</mat-icon>
                  <p>{{ isSearching ? 'No se encontraron operaciones que coincidan con la búsqueda.' : 'No hay operaciones para mostrar.' }}</p>
                </div>

                <!-- Tabla de Operaciones Pendientes -->
                <div class="table-container" *ngIf="!isLoadingOperations && !operationsError && getDisplayPendingOperations().length > 0">
                  <h3>Operaciones Pendientes ({{ getDisplayPendingOperations().length }})</h3>
                  <table mat-table [dataSource]="getDisplayPendingOperations()" class="mat-elevation-z4 operations-table">
                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                      <th mat-header-cell *matHeaderCellDef> ID </th>
                      <td mat-cell *matCellDef="let operation"> {{operation.id}} </td>
                    </ng-container>

                    <!-- OperationType Column -->
                    <ng-container matColumnDef="operationType">
                      <th mat-header-cell *matHeaderCellDef> Tipo </th>
                      <td mat-cell *matCellDef="let operation">
                        <mat-chip [color]="getOperationTypeColor(operation.operationType)" selected>
                          {{ getOperationTypeText(operation.operationType) }}
                        </mat-chip>
                      </td>
                    </ng-container>

                    <!-- DescripcionOperacion Column -->
                    <ng-container matColumnDef="descripcionOperacion">
                      <th mat-header-cell *matHeaderCellDef> Descripción operación </th>
                      <td mat-cell *matCellDef="let operation">
                        {{ operation.descripcionOperacion || 'Sin descripción' }}
                      </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                      <th mat-header-cell *matHeaderCellDef> Estado </th>
                      <td mat-cell *matCellDef="let operation">
                        <mat-chip [color]="getStatusColor(operation.status)" selected>
                          {{ operation.status }}
                        </mat-chip>
                      </td>
                    </ng-container>

                    <!-- User Column -->
                    <ng-container matColumnDef="user">
                      <th mat-header-cell *matHeaderCellDef> Usuario </th>
                      <td mat-cell *matCellDef="let operation">
                        {{ getUserName(operation) }}
                      </td>
                    </ng-container>

                    <!-- MinutesAlive Column -->
                    <ng-container matColumnDef="minutesAlive">
                      <th mat-header-cell *matHeaderCellDef> Caducidad </th>
                                        <td mat-cell *matCellDef="let operation">
                    {{ operation.minutesAlive }} horas
                  </td>
                    </ng-container>

                    <!-- CreatedAt Column -->
                    <ng-container matColumnDef="createdAt">
                      <th mat-header-cell *matHeaderCellDef> Fecha Creación </th>
                      <td mat-cell *matCellDef="let operation">
                        {{operation.createdAt | date:'dd/MM/yyyy HH:mm'}}
                      </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef class="actions-header"> Acciones </th>
                      <td mat-cell *matCellDef="let operation" class="actions-cell">
                        <button mat-icon-button color="primary" (click)="viewOperation(operation)" matTooltip="Ver Operación">
                          <mat-icon>visibility</mat-icon>
                        </button>
                        <button 
                          *ngIf="operation.status === 'Pendiente'"
                          mat-icon-button 
                          color="accent" 
                          (click)="launchOperation(operation)" 
                          matTooltip="Lanzar Operación">
                          <mat-icon>flight_takeoff</mat-icon>
                        </button>
                        <button 
                          *ngIf="operation.status === 'Pendiente'"
                          mat-icon-button 
                          color="primary" 
                          (click)="editOperation(operation)" 
                          matTooltip="Editar Operación">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button 
                          *ngIf="operation.status !== 'Pendiente'"
                          mat-icon-button 
                          color="primary" 
                          (click)="relaunchOperation(operation)" 
                          matTooltip="Relanzar Operación">
                          <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="deleteOperation(operation)" matTooltip="Eliminar Operación">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="operationsDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: operationsDisplayedColumns;"></tr>
                  </table>
                </div>

                <!-- Tabla de Otras Operaciones -->
                <div class="table-container" *ngIf="!isLoadingOperations && !operationsError && getDisplayNonPendingOperations().length > 0">
                  <h3>Otras Operaciones ({{ getDisplayNonPendingOperations().length }})</h3>
                  <table mat-table [dataSource]="getDisplayNonPendingOperations()" class="mat-elevation-z4 operations-table">
                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                      <th mat-header-cell *matHeaderCellDef> ID </th>
                      <td mat-cell *matCellDef="let operation"> {{operation.id}} </td>
                    </ng-container>

                    <!-- OperationType Column -->
                    <ng-container matColumnDef="operationType">
                      <th mat-header-cell *matHeaderCellDef> Tipo </th>
                      <td mat-cell *matCellDef="let operation">
                        <mat-chip [color]="getOperationTypeColor(operation.operationType)" selected>
                          {{ getOperationTypeText(operation.operationType) }}
                        </mat-chip>
                      </td>
                    </ng-container>

                    <!-- DescripcionOperacion Column -->
                    <ng-container matColumnDef="descripcionOperacion">
                      <th mat-header-cell *matHeaderCellDef> Descripción operación </th>
                      <td mat-cell *matCellDef="let operation">
                        {{ operation.descripcionOperacion || 'Sin descripción' }}
                      </td>
                    </ng-container>

                    <!-- Status Column -->
                    <ng-container matColumnDef="status">
                      <th mat-header-cell *matHeaderCellDef> Estado </th>
                      <td mat-cell *matCellDef="let operation">
                        <mat-chip [color]="getStatusColor(operation.status)" selected>
                          {{ operation.status }}
                        </mat-chip>
                      </td>
                    </ng-container>

                    <!-- User Column -->
                    <ng-container matColumnDef="user">
                      <th mat-header-cell *matHeaderCellDef> Usuario </th>
                      <td mat-cell *matCellDef="let operation">
                        {{ getUserName(operation) }}
                      </td>
                    </ng-container>

                    <!-- MinutesAlive Column -->
                    <ng-container matColumnDef="minutesAlive">
                      <th mat-header-cell *matHeaderCellDef> Caducidad </th>
                                        <td mat-cell *matCellDef="let operation">
                    {{ operation.minutesAlive }} horas
                  </td>
                    </ng-container>

                    <!-- CreatedAt Column -->
                    <ng-container matColumnDef="createdAt">
                      <th mat-header-cell *matHeaderCellDef> Fecha Creación </th>
                      <td mat-cell *matCellDef="let operation">
                        {{operation.createdAt | date:'dd/MM/yyyy HH:mm'}}
                      </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef class="actions-header"> Acciones </th>
                      <td mat-cell *matCellDef="let operation" class="actions-cell">
                        <button mat-icon-button color="primary" (click)="viewOperation(operation)" matTooltip="Ver Operación">
                          <mat-icon>visibility</mat-icon>
                        </button>
                        <button 
                          *ngIf="operation.status === 'Pendiente'"
                          mat-icon-button 
                          color="primary" 
                          (click)="editOperation(operation)" 
                          matTooltip="Editar Operación">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button 
                          *ngIf="operation.status !== 'Pendiente'"
                          mat-icon-button 
                          color="primary" 
                          (click)="relaunchOperation(operation)" 
                          matTooltip="Relanzar Operación">
                          <mat-icon>refresh</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="deleteOperation(operation)" matTooltip="Eliminar Operación">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="operationsDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: operationsDisplayedColumns;"></tr>
                  </table>
                </div>

                <!-- Paginación -->
                <mat-paginator 
                  *ngIf="operationsPagination && getDisplayOperations().length > 0"
                  [length]="operationsPagination.totalCount"
                  [pageSize]="currentSearch.pageSize"
                  [pageSizeOptions]="[5, 10, 25, 50]"
                  [pageIndex]="currentSearch.page - 1"
                  (page)="onPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <!-- Pestaña de Empresas (solo para Administrador) -->
          <mat-tab label="Empresas" *ngIf="currentUser?.role === Role.Administrador">
            <mat-card class="companies-card">
              <mat-card-header>
                <button mat-flat-button color="accent" class="create-company-button"
                        (click)="openCreateCompanyDialog()">
                  <mat-icon>add_business</mat-icon> Crear Empresa
                </button>
                <button mat-icon-button (click)="loadCompanies()" matTooltip="Recargar lista">
                  <mat-icon>refresh</mat-icon>
                </button>
              </mat-card-header>
              <mat-card-content>
                <!-- Spinner de carga -->
                <div *ngIf="isLoadingCompanies" class="spinner-container">
                  <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
                  <p>Cargando empresas...</p>
                </div>

                <!-- Mensaje de error -->
                <div *ngIf="!isLoadingCompanies && companiesError" class="error-message-companies">
                  <mat-icon color="warn">error_outline</mat-icon>
                  <p>{{ companiesError }}</p>
                  <button mat-stroked-button color="primary" (click)="loadCompanies()">Reintentar</button>
                </div>

                <!-- Estado vacío -->
                <div *ngIf="!isLoadingCompanies && !companiesError && companies.length === 0" class="empty-state-companies">
                  <mat-icon class="empty-icon">business</mat-icon>
                  <p>No hay empresas registradas.</p>
                </div>

                <!-- Tabla de Empresas -->
                <div class="table-container" *ngIf="!isLoadingCompanies && !companiesError && companies.length > 0">
                  <table mat-table [dataSource]="displayedCompanies" class="mat-elevation-z4 users-table">
                    <!-- ID Column -->
                    <ng-container matColumnDef="id">
                      <th mat-header-cell *matHeaderCellDef> ID </th>
                      <td mat-cell *matCellDef="let company"> {{company.id}} </td>
                    </ng-container>

                    <!-- Name Column -->
                    <ng-container matColumnDef="name">
                      <th mat-header-cell *matHeaderCellDef> Nombre Empresa </th>
                      <td mat-cell *matCellDef="let company"> {{company.name}} </td>
                    </ng-container>

                    <!-- NumberOfAgents Column -->
                    <ng-container matColumnDef="numberOfAgents">
                      <th mat-header-cell *matHeaderCellDef> Agentes </th>
                      <td mat-cell *matCellDef="let company"> {{company.numberOfAgents}} </td>
                    </ng-container>

                    <!-- CreatedAt Column -->
                    <ng-container matColumnDef="createdAt">
                      <th mat-header-cell *matHeaderCellDef> Fecha Creación </th>
                      <td mat-cell *matCellDef="let company"> {{company.createdAt | date:'dd/MM/yyyy HH:mm'}} </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                      <th mat-header-cell *matHeaderCellDef> Acciones </th>
                      <td mat-cell *matCellDef="let company">
                        <button mat-icon-button color="primary" (click)="openEditCompanyDialog(company)" matTooltip="Editar Empresa">
                          <mat-icon>edit</mat-icon>
                        </button>
                        <button mat-icon-button color="warn" (click)="deleteCompany(company)" matTooltip="Eliminar Empresa">
                          <mat-icon>delete</mat-icon>
                        </button>
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="companyDisplayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: companyDisplayedColumns;"></tr>
                  </table>
                  <mat-paginator [length]="totalCompanies"
                                 [pageSize]="companiesPageSize"
                                 [pageSizeOptions]="[5, 10, 25, 50]"
                                 (page)="onCompaniesPageChange($event)"
                                 showFirstLastButtons>
                  </mat-paginator>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>
        </mat-tab-group>
    </div>
  </div>
</div>

<style>
/* Estilos copiados de operation-list para mantener consistencia */

.operations-table {
  width: 100%;
  min-width: 1200px; /* Asegurar que todas las columnas sean visibles */
}

.operations-table .mat-mdc-header-cell {
  font-size: 13px;
  font-weight: 500;
  color: rgba(0,0,0,0.7);
  padding: 12px 8px;
}

.operations-table .mat-mdc-cell {
  font-size: 13px;
  padding: 8px;
}

/* Asegurar que la columna de descripción sea visible */
.operations-table .mat-column-descripcionOperacion {
  min-width: 200px !important;
  max-width: 300px;
  word-wrap: break-word;
  display: table-cell !important;
  visibility: visible !important;
}

.operations-table .mat-mdc-header-cell.mat-column-descripcionOperacion {
  min-width: 200px !important;
  display: table-cell !important;
  visibility: visible !important;
}

.operations-table .mat-mdc-row:hover {
  background-color: rgba(0,0,0,0.02);
}

.actions-header { 
  text-align: center !important;
  width: 400px;
  min-width: 400px;
}

.actions-cell { 
  text-align: center !important;
  width: 400px;
  min-width: 400px;
  white-space: nowrap;
}

.mat-mdc-table .mat-mdc-cell.actions-cell button:not(:last-child),
.mat-mdc-table .mat-mdc-header-cell.actions-header button:not(:last-child) {
  margin-right: 8px;
}

/* Asegurar que los botones estén siempre en línea */
.actions-cell .mat-mdc-button,
.actions-cell .mat-mdc-icon-button {
  display: inline-flex !important;
  flex-direction: row !important;
  align-items: center !important;
  justify-content: center !important;
  width: 48px !important;
  height: 48px !important;
  min-width: 48px !important;
  min-height: 48px !important;
}

/* Estilos para los iconos dentro de los botones */
.actions-cell .mat-mdc-icon-button mat-icon {
  font-size: 24px !important;
  width: 24px !important;
  height: 24px !important;
  line-height: 24px !important;
}

/* Estilos para el botón de ver operación */
.actions-cell button[matTooltip="Ver Operación"] {
  color: #1976d2 !important;
}

.actions-cell button[matTooltip="Ver Operación"]:hover {
  background-color: rgba(25, 118, 210, 0.1) !important;
}

/* Estilos para el botón de lanzar operación */
.actions-cell button[matTooltip="Lanzar Operación"] {
  color: #ff4081 !important;
}

.actions-cell button[matTooltip="Lanzar Operación"]:hover {
  background-color: rgba(255, 64, 129, 0.1) !important;
}

/* Estilos para el botón de editar */
.actions-cell button[matTooltip="Editar Operación"] {
  color: #1976d2 !important;
}

.actions-cell button[matTooltip="Editar Operación"]:hover {
  background-color: rgba(25, 118, 210, 0.1) !important;
}

/* Estilos para el botón de eliminar */
.actions-cell button[matTooltip="Eliminar Operación"] {
  color: #f44336 !important;
}

.actions-cell button[matTooltip="Eliminar Operación"]:hover {
  background-color: rgba(244, 67, 54, 0.1) !important;
}

/* Estilos para el botón de relanzar operación */
.actions-cell button[matTooltip="Relanzar Operación"] {
  color: #1976d2 !important;
}

.actions-cell button[matTooltip="Relanzar Operación"]:hover {
  background-color: rgba(25, 118, 210, 0.1) !important;
}
</style>