<div class="auth-page-container">
  <mat-card class="auth-card">
    <mat-card-header>
      <mat-card-title>Establecer Nueva Contraseña</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <!-- Mensaje si el token no es válido (se muestra si this.errorMessage se setea en ngOnInit) -->
      <div *ngIf="!token" class="token-error-container">
        <p class="description-text error-text">{{ errorMessage || 'Enlace no válido o token no proporcionado.' }}</p>
        <a mat-stroked-button color="primary" routerLink="/login" class="full-width" style="margin-top: 10px;">Volver a Iniciar Sesión</a>
      </div>

      <!-- Formulario si el token es válido -->
      <form *ngIf="token" [formGroup]="setPasswordForm" (ngSubmit)="onSubmit()">
        <p class="description-text" *ngIf="emailFromQuery">
          Estableciendo tu contraseña para la cuenta asociada a <strong>{{ emailFromQuery }}</strong>.
        </p>
        <p class="description-text" *ngIf="!emailFromQuery">
          Por favor, establece tu nueva contraseña.
        </p>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Nueva Contraseña</mat-label>
          <input matInput [type]="hideNewPassword ? 'password' : 'text'" formControlName="newPassword" required autocomplete="new-password">
          <button mat-icon-button matSuffix (click)="toggleNewPasswordVisibility($event)" [attr.aria-label]="'Toggle new password visibility'" type="button">
            <mat-icon>{{hideNewPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="fc['newPassword']?.touched && fc['newPassword']?.errors?.['required']">
            Nueva contraseña es requerida.
          </mat-error>
          <mat-error *ngIf="fc['newPassword']?.touched && fc['newPassword']?.errors?.['minlength']">
            Debe tener al menos 8 caracteres.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirmar Nueva Contraseña</mat-label>
          <input matInput [type]="hideConfirmPassword ? 'password' : 'text'" formControlName="confirmPassword" required autocomplete="new-password">
          <button mat-icon-button matSuffix (click)="toggleConfirmPasswordVisibility($event)" [attr.aria-label]="'Toggle confirm password visibility'" type="button">
            <mat-icon>{{hideConfirmPassword ? 'visibility_off' : 'visibility'}}</mat-icon>
          </button>
          <mat-error *ngIf="fc['confirmPassword']?.touched && fc['confirmPassword']?.errors?.['required']">
            Confirmar contraseña es requerido.
          </mat-error>
          <mat-error *ngIf="setPasswordForm.errors?.['passwordMismatch'] && (fc['confirmPassword']?.touched || fc['newPassword']?.touched)">
            Las contraseñas no coinciden.
          </mat-error>
        </mat-form-field>

        <!-- Checkbox de Política de Privacidad -->
        <div class="checkbox-container full-width">
          <mat-checkbox formControlName="privacyPolicyAccepted" required color="primary">
            He leído y acepto la <a href="/politica-privacidad" target="_blank" rel="noopener noreferrer">política de privacidad</a>.
          </mat-checkbox>
          <mat-error *ngIf="fc['privacyPolicyAccepted']?.touched && fc['privacyPolicyAccepted']?.errors?.['requiredTrue']" class="checkbox-error">
            Debes aceptar la política de privacidad para continuar.
          </mat-error>
        </div>

        <button mat-raised-button color="primary" type="submit" [disabled]="!setPasswordForm || setPasswordForm.invalid || isLoading" class="full-width">
          <span *ngIf="!isLoading">Establecer Contraseña</span>
          <mat-spinner *ngIf="isLoading" diameter="24" style="margin: 0 auto;"></mat-spinner>
        </button>
      </form>
    </mat-card-content>

    <!-- Contenedor para mensajes de error del submit del formulario -->
    <div *ngIf="errorMessage && token" class="error-message-container"> <!-- Solo mostrar si hay token, indicando que el error es del submit -->
        <p class="error-text">{{ errorMessage }}</p>
    </div>
  </mat-card>
</div>